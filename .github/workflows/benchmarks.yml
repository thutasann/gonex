name: Benchmark Suite

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to run benchmarks on'
        required: true
        default: 'master'
        type: string

jobs:
  benchmarks:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || github.event.inputs.branch == 'master'
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || 'master' }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install root project dependencies
        run: npm ci

      - name: Build root project
        run: npm run build

      - name: Install benchmark dependencies
        working-directory: ./benchmarks
        run: npm install

      - name: Run benchmarks
        working-directory: ./benchmarks
        run: |
          echo "🚀 Running benchmarks..."
          npm run benchmark
          echo ""
          echo "📊 Checking results directory:"
          ls -la results/ || echo "No results directory found"
          echo ""
          echo "📁 Results structure:"
          find results/ -type f 2>/dev/null || echo "No results files found"

          # Copy results to a location that won't be ignored
          if [ -d "results" ]; then
            echo "📂 Copying results to temp location..."
            cp -r results ../benchmark-results-temp
            echo "✅ Results copied to ../benchmark-results-temp"
          else
            echo "❌ No results directory found"
            exit 1
          fi

      - name: Display benchmark summary
        working-directory: ./benchmarks
        run: |
          echo "📊 Benchmark Results Generated"
          echo "================================"
          ls -la results/
          echo ""
          echo "📝 Latest Results:"
          if [ -f results/*.md ]; then
            head -n 20 results/*.md | tail -n +1
          fi

          # Show the structure of results
          echo ""
          echo "📁 Results Structure:"
          find results/ -type f -name "*.json" -o -name "*.md" | head -10

      - name: Prepare benchmark results for GitHub
        run: |
          # Create simple README for the results
          echo "# Gonex Benchmark Results" > README.md
          echo "" >> README.md
          echo "Performance benchmarks for the Gonex concurrency library." >> README.md
          echo "" >> README.md
          echo "📅 **Generated:** $(date -u)" >> README.md
          echo "🌟 **Branch:** ${{ github.event.inputs.branch || github.ref_name }}" >> README.md
          echo "🔗 **Commit:** [\`${{ github.sha }}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})" >> README.md
          echo "" >> README.md
          echo "## 📊 Results Structure" >> README.md
          echo "" >> README.md
          echo "Results are organized by date and time:" >> README.md
          echo "- Date folders: YYYY-MM-DD" >> README.md
          echo "- Time folders: HH-MM-SS" >> README.md
          echo "" >> README.md
          echo "📁 [View Results](./results/)" >> README.md

      - name: Commit results to benchmark-results branch
        run: |
          # Configure git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Actions"

          # Try to fetch the benchmark-results branch
          git fetch origin benchmark-results:benchmark-results 2>/dev/null || echo "Branch doesn't exist yet"

          # Reset any uncommitted changes
          git reset --hard HEAD || echo "No changes to reset"

          # Create or checkout the branch
          if git show-ref --verify --quiet refs/heads/benchmark-results; then
            git checkout benchmark-results
          else
            git checkout -b benchmark-results
          fi

          # Preserve existing results by copying them to temp
          if [ -d "results" ]; then
            echo "📂 Preserving existing results..."
            cp -r results temp-existing-results
            echo "✅ Existing results preserved"
          fi

          # Clear everything except .git, temp results, and existing results
          find . -mindepth 1 -maxdepth 1 ! -name '.git' ! -name 'benchmark-results-temp' ! -name 'temp-existing-results' -exec rm -rf {} +

          # Copy results from temp location to root
          if [ -d "benchmark-results-temp" ]; then
            cp -r benchmark-results-temp results
            echo "✅ New results folder copied to root"
            # Clean up temp location
            rm -rf benchmark-results-temp
          else
            echo "❌ No results folder found in temp location"
            exit 1
          fi

          # Merge existing results back
          if [ -d "temp-existing-results" ]; then
            echo "📂 Merging existing results..."
            # Copy existing results back, preserving all date/time folders
            cp -r temp-existing-results/* results/
            rm -rf temp-existing-results
            echo "✅ Existing results merged back"
          fi

          # Create README.md at the root
          echo "# Gonex Benchmark Results" > README.md
          echo "" >> README.md
          echo "Performance benchmarks for the Gonex concurrency library." >> README.md
          echo "" >> README.md
          echo "📅 **Last Updated:** $(date -u)" >> README.md
          echo "🌟 **Branch:** ${{ github.event.inputs.branch || github.ref_name }}" >> README.md
          echo "🔗 **Commit:** [\`${{ github.sha }}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})" >> README.md
          echo "" >> README.md
          echo "## 📊 Results Structure" >> README.md
          echo "" >> README.md
          echo "Results are organized by date and time:" >> README.md
          echo "- Date folders: YYYY-MM-DD" >> README.md
          echo "- Time folders: HH-MM-SS" >> README.md
          echo "" >> README.md
          echo "📁 [View Results](./results/)" >> README.md
          echo "" >> README.md
          echo "## 📈 Latest Runs" >> README.md
          echo "" >> README.md
          # List the most recent 5 date folders
          if [ -d "results" ]; then
            echo "Recent benchmark runs:" >> README.md
            echo "" >> README.md
            for date_dir in $(ls -1 results/ | grep -E '^[0-9]{4}-[0-9]{2}-[0-9]{2}$' | sort -r | head -5); do
              if [ -d "results/$date_dir" ]; then
                echo "### 📅 $date_dir" >> README.md
                # List the most recent time folder for this date
                latest_time=$(ls -1 results/$date_dir/ | grep -E '^[0-9]{2}-[0-9]{2}-[0-9]{2}$' | sort -r | head -1)
                if [ -n "$latest_time" ]; then
                  echo "- [🕐 $latest_time](./results/$date_dir/$latest_time/)" >> README.md
                fi
                echo "" >> README.md
              fi
            done
          fi

          # Add and commit
          git add .
          git commit -m "📊 Benchmark results from ${{ github.event.inputs.branch || github.ref_name }} ($(date -u +"%Y-%m-%d %H:%M:%S UTC"))" || echo "No changes to commit"

          # Push to benchmark-results branch
          git push origin benchmark-results

      - name: Comment with results links
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## 📊 Benchmark Results

            🎯 **Latest Results:** [View on benchmark-results branch](https://github.com/${{ github.repository }}/tree/benchmark-results/latest)
            📈 **All Historical Results:** [View history](https://github.com/${{ github.repository }}/tree/benchmark-results/history)
            📁 **Artifacts:** Available in workflow artifacts as backup

            **Quick Access:**
            - 📋 [README](https://github.com/${{ github.repository }}/blob/benchmark-results/README.md)
            - 📊 [Latest JSON Results](https://github.com/${{ github.repository }}/tree/benchmark-results/latest)
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
