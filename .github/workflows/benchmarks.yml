name: Benchmark Suite

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to run benchmarks on'
        required: true
        default: 'master'
        type: string

jobs:
  benchmarks:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || github.event.inputs.branch == 'master'
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || 'master' }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install root project dependencies
        run: npm ci

      - name: Build root project
        run: npm run build

      - name: Install benchmark dependencies
        working-directory: ./benchmarks
        run: npm install

      - name: Run benchmarks
        working-directory: ./benchmarks
        run: npm run benchmark

      - name: Display benchmark summary
        working-directory: ./benchmarks
        run: |
          echo "ğŸ“Š Benchmark Results Generated"
          echo "================================"
          ls -la results/
          echo ""
          echo "ğŸ“ Latest Results:"
          if [ -f results/*.md ]; then
            head -n 20 results/*.md | tail -n +1
                      fi

      - name: Prepare benchmark results for GitHub
        run: |
          # Create timestamps for this run
          DATE_FOLDER=$(date -u +"%Y-%m-%d")
          TIME_FOLDER=$(date -u +"%H-%M-%S")
          RUN_ID=$(date -u +"%Y%m%d_%H%M%S")
          COMMIT_SHA="${{ github.sha }}"
          BRANCH_NAME="${{ github.event.inputs.branch || github.ref_name }}"

          # Create results directory structure with date-based organization
          mkdir -p github-results
          mkdir -p github-results/latest
          mkdir -p github-results/history/${DATE_FOLDER}/${TIME_FOLDER}

          # Copy results to structured directories
          if [ -d "benchmarks/results" ]; then
            # Copy all date folders to history
            cp -r benchmarks/results/* github-results/history/
            
            # Copy the most recent results to latest folder
            # Find the most recent date folder
            LATEST_DATE=$(ls -1 benchmarks/results/ | grep -E '^[0-9]{4}-[0-9]{2}-[0-9]{2}$' | sort -r | head -1)
            if [ -n "$LATEST_DATE" ]; then
              # Find the most recent time folder in the latest date
              LATEST_TIME=$(ls -1 benchmarks/results/${LATEST_DATE}/ | grep -E '^[0-9]{2}-[0-9]{2}-[0-9]{2}$' | sort -r | head -1)
              if [ -n "$LATEST_TIME" ]; then
                cp -r benchmarks/results/${LATEST_DATE}/${LATEST_TIME}/* github-results/latest/
              fi
            fi
            
            # Create function-based organization
            mkdir -p github-results/by-function
            
            # Organize by function type if JSON files exist
            # Find all JSON files in date folders
            for json_file in $(find benchmarks/results -name "*.json" -type f); do
              if [ -f "$json_file" ]; then
                # Extract function name from filename or content
                filename=$(basename "$json_file")
                
                # Try to determine function type from filename or content
                if [[ "$filename" == *"goroutine"* ]]; then
                  func_type="goroutines"
                elif [[ "$filename" == *"channel"* ]]; then
                  func_type="channels"
                elif [[ "$filename" == *"mutex"* ]]; then
                  func_type="mutex"
                elif [[ "$filename" == *"waitgroup"* ]]; then
                  func_type="waitgroups"
                elif [[ "$filename" == *"semaphore"* ]]; then
                  func_type="semaphores"
                elif [[ "$filename" == *"ctx"* ]] || [[ "$filename" == *"context"* ]]; then
                  func_type="context"
                elif [[ "$filename" == *"select"* ]]; then
                  func_type="select"
                elif [[ "$filename" == *"once"* ]]; then
                  func_type="once"
                else
                  func_type="other"
                fi
                
                # Create function directory and copy files
                mkdir -p "github-results/by-function/${func_type}"
                cp "$json_file" "github-results/by-function/${func_type}/"
                
                # Copy corresponding markdown file if exists
                md_file="${json_file%.json}.md"
                if [ -f "$md_file" ]; then
                  cp "$md_file" "github-results/by-function/${func_type}/"
                fi
              fi
            done
            
            # Create function-based index
            echo "# Benchmark Results by Function" > github-results/by-function/README.md
            echo "" >> github-results/by-function/README.md
            echo "Benchmark results organized by concurrency primitive type:" >> github-results/by-function/README.md
            echo "" >> github-results/by-function/README.md
            
            # List all function types
            for func_dir in github-results/by-function/*/; do
              if [ -d "$func_dir" ]; then
                func_name=$(basename "$func_dir")
                echo "## ğŸ”§ ${func_name^}" >> github-results/by-function/README.md
                echo "" >> github-results/by-function/README.md
                
                # List files in this function directory
                for file in "$func_dir"*; do
                  if [ -f "$file" ]; then
                    filename=$(basename "$file")
                    echo "- [${filename}](./${func_name}/${filename})" >> github-results/by-function/README.md
                  fi
                done
                echo "" >> github-results/by-function/README.md
              fi
            done
            
            # Create main index file
            echo "# Benchmark Results" > github-results/README.md
            echo "" >> github-results/README.md
            echo "## Latest Results" >> github-results/README.md
            echo "" >> github-results/README.md
            echo "ğŸ“Š **Run Date:** $(date -u)" >> github-results/README.md
            echo "ğŸŒŸ **Branch:** ${BRANCH_NAME}" >> github-results/README.md
            echo "ğŸ”— **Commit:** [\`${COMMIT_SHA:0:7}\`](https://github.com/${{ github.repository }}/commit/${COMMIT_SHA})" >> github-results/README.md
            echo "" >> github-results/README.md
            echo "### ğŸ“ [View Latest Results](./latest/)" >> github-results/README.md
            echo "### ğŸ“ˆ [View Historical Results](./history/)" >> github-results/README.md
            echo "" >> github-results/README.md
            
            # Add quick summary if markdown files exist
            # Find the most recent markdown file
            LATEST_MD=$(find benchmarks/results -name "*.md" -type f | sort -r | head -1)
            if [ -n "$LATEST_MD" ] && [ -f "$LATEST_MD" ]; then
              echo "## Quick Summary" >> github-results/README.md
              echo "" >> github-results/README.md
              echo "\`\`\`" >> github-results/README.md
              head -n 30 "$LATEST_MD" >> github-results/README.md
              echo "\`\`\`" >> github-results/README.md
            fi
            
            # Create history index (organized by dates)
            echo "# Benchmark History" > github-results/history/README.md
            echo "" >> github-results/history/README.md
            echo "Benchmark runs organized by date:" >> github-results/history/README.md
            echo "" >> github-results/history/README.md
            
            # List all date folders in reverse chronological order
            if [ -d "github-results/history" ]; then
              for date_dir in $(ls -1 github-results/history/ | grep -E '^[0-9]{4}-[0-9]{2}-[0-9]{2}$' | sort -r); do
                if [ -d "github-results/history/${date_dir}" ]; then
                  echo "## ğŸ“… ${date_dir}" >> github-results/history/README.md
                  echo "" >> github-results/history/README.md
                  
                  # List time folders for this date
                  for time_dir in $(ls -1 github-results/history/${date_dir}/ | grep -E '^[0-9]{2}-[0-9]{2}-[0-9]{2}$' | sort -r); do
                    if [ -d "github-results/history/${date_dir}/${time_dir}" ]; then
                      echo "- [${time_dir} UTC](./${date_dir}/${time_dir}/)" >> github-results/history/README.md
                    fi
                  done
                  echo "" >> github-results/history/README.md
                fi
              done
            fi
            
            # Create daily summary file for today's date
            echo "# Benchmark Results for ${DATE_FOLDER}" > github-results/history/${DATE_FOLDER}/README.md
            echo "" >> github-results/history/${DATE_FOLDER}/README.md
            echo "All benchmark runs for $(date -u -d ${DATE_FOLDER} '+%B %d, %Y'):" >> github-results/history/${DATE_FOLDER}/README.md
            echo "" >> github-results/history/${DATE_FOLDER}/README.md
            
            # List all runs for today
            for time_dir in $(ls -1 github-results/history/${DATE_FOLDER}/ | grep -E '^[0-9]{2}-[0-9]{2}-[0-9]{2}$' | sort -r); do
              if [ -d "github-results/history/${DATE_FOLDER}/${time_dir}" ]; then
                echo "## ğŸ• ${time_dir} UTC" >> github-results/history/${DATE_FOLDER}/README.md
                echo "" >> github-results/history/${DATE_FOLDER}/README.md
                echo "**Branch:** ${BRANCH_NAME}" >> github-results/history/${DATE_FOLDER}/README.md
                echo "**Commit:** [\`${COMMIT_SHA:0:7}\`](https://github.com/${{ github.repository }}/commit/${COMMIT_SHA})" >> github-results/history/${DATE_FOLDER}/README.md
                echo "" >> github-results/history/${DATE_FOLDER}/README.md
                echo "ğŸ“ [View Results](./${time_dir}/)" >> github-results/history/${DATE_FOLDER}/README.md
                echo "" >> github-results/history/${DATE_FOLDER}/README.md
                
                # Add quick preview of results if available
                if [ -f "github-results/history/${DATE_FOLDER}/${time_dir}/"*.md ]; then
                  echo "**Quick Preview:**" >> github-results/history/${DATE_FOLDER}/README.md
                  echo "\`\`\`" >> github-results/history/${DATE_FOLDER}/README.md
                  head -n 10 github-results/history/${DATE_FOLDER}/${time_dir}/*.md | head -n 10 >> github-results/history/${DATE_FOLDER}/README.md
                  echo "\`\`\`" >> github-results/history/${DATE_FOLDER}/README.md
                  echo "" >> github-results/history/${DATE_FOLDER}/README.md
                fi
              fi
            done
          fi

      - name: Commit results to benchmark-results branch
        run: |
          # Configure git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Actions"

          # Check if benchmark-results branch exists
          git fetch origin benchmark-results:benchmark-results 2>/dev/null || git checkout --orphan benchmark-results

          # Switch to benchmark-results branch
          git checkout benchmark-results 2>/dev/null || echo "Already on benchmark-results branch"

          # Clear everything except .git
          find . -mindepth 1 -maxdepth 1 ! -name '.git' ! -name 'github-results' -exec rm -rf {} +

          # Move results to root
          if [ -d "github-results" ]; then
            mv github-results/* .
            rmdir github-results
          fi

          # Add and commit
          git add .
          git commit -m "ğŸ“Š Benchmark results from ${{ github.event.inputs.branch || github.ref_name }} ($(date -u +"%Y-%m-%d %H:%M:%S UTC"))" || exit 0

          # Push to benchmark-results branch
          git push origin benchmark-results

      - name: Create GitHub Pages index (optional)
        run: |
          # Switch back to benchmark-results for Pages setup
          git checkout benchmark-results

          # Create a simple index.html for GitHub Pages (if enabled)
          cat > index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Gonex Benchmark Results</title>
              <style>
                  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; margin: 40px; }
                  .container { max-width: 800px; margin: 0 auto; }
                  .header { border-bottom: 1px solid #eee; padding-bottom: 20px; margin-bottom: 30px; }
                  .section { margin: 20px 0; }
                  .link-button { display: inline-block; padding: 10px 20px; background: #0366d6; color: white; text-decoration: none; border-radius: 6px; margin: 5px; }
                  .link-button:hover { background: #0256cc; }
                  .timestamp { color: #666; font-size: 14px; }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>ğŸš€ Gonex Benchmark Results</h1>
                      <p>Performance benchmarks for the Gonex concurrency library</p>
                  </div>
                  
                  <div class="section">
                      <h2>ğŸ“Š Latest Results</h2>
                      <a href="./latest/" class="link-button">View Latest Benchmarks</a>
                      <a href="./README.md" class="link-button">View README</a>
                  </div>
                  
                  <div class="section">
                      <h2>ğŸ“ˆ Historical Data</h2>
                      <a href="./history/" class="link-button">Browse History</a>
                      <p class="timestamp">Results are updated automatically when benchmarks run</p>
                  </div>
                  
                  <div class="section">
                      <h2>ğŸ”— Links</h2>
                      <a href="https://github.com/${{ github.repository }}" class="link-button">Main Repository</a>
                      <a href="https://github.com/${{ github.repository }}/tree/benchmark-results" class="link-button">Results Branch</a>
                  </div>
              </div>
          </body>
          </html>
          EOF

          # Commit the index.html
          git add index.html
          git commit -m "ğŸ“„ Add GitHub Pages index" || echo "No changes to commit"
          git push origin benchmark-results

      - name: Upload benchmark artifacts (backup)
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-${{ github.sha }}
          path: benchmarks/results/
          retention-days: 30

      - name: Comment with results links
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## ğŸ“Š Benchmark Results

            ğŸ¯ **Latest Results:** [View on benchmark-results branch](https://github.com/${{ github.repository }}/tree/benchmark-results/latest)
            ğŸ“ˆ **All Historical Results:** [View history](https://github.com/${{ github.repository }}/tree/benchmark-results/history)
            ğŸ“ **Artifacts:** Available in workflow artifacts as backup

            **Quick Access:**
            - ğŸ“‹ [README](https://github.com/${{ github.repository }}/blob/benchmark-results/README.md)
            - ğŸ“Š [Latest JSON Results](https://github.com/${{ github.repository }}/tree/benchmark-results/latest)
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
